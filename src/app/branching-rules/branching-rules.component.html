<app-sidebar></app-sidebar>
<app-header></app-header>

<section class="user-main-content">
  <div class="task-container">
    <div class="task-row">
      <div class="task-all-wrap">
        <div class="form-card-wrap">
          <!-- Already Added Rules Section -->
          <div
            *ngIf="getAllBranchingRulesData && getAllBranchingRulesData.data.length > 0"
            class="already-added-rules"
          >
            <h4 class="rules-title">Already Added Rules</h4>
            <div class="rules-list">
              <div
                *ngFor="let rulesBreak of getAllBranchingRulesData.data"
                class="rule-card"
              >
                <div class="rule-header">
                  <span class="action-text">IF Parameter : </span>
                  <span class="parameter-name">{{
                    rulesBreak.parameter_name
                  }}</span>
                  <span class="arrow">➔</span>
                  <span class="action-text">Value </span>
                  <span class="parameter-value">{{ rulesBreak.operator }}</span>
                  <span class="action-text"> : </span>
                  <span class="parameter-value">{{
                    rulesBreak.parameter_value
                  }}</span>
                </div>
                <div class="rule-body">
                  <span class="action-text">Action:</span>
                  <span class="action-detail">
                    <ng-container
                      *ngIf="
                        rulesBreak.action_type ===
                        BranchingActionType['HIDE_PARAMETER']
                      "
                    >
                      <span class="action-text">Hide Parameter ➔ </span>
                      <span class="parameter-value">{{
                        rulesBreak.target_parameter_name
                      }}</span>
                    </ng-container>
                    <ng-container
                      *ngIf="
                        rulesBreak.action_type ===
                        BranchingActionType['DISPLAY_MESSAGE']
                      "
                    >
                      <span class="action-text">Display Message ➔ </span>
                      <span class="parameter-value">{{
                        rulesBreak.display_message_content
                      }}</span>
                    </ng-container>
                    <ng-container
                      *ngIf="
                        rulesBreak.action_type ===
                        BranchingActionType['APPLY_VALIDATION']
                      "
                    >
                      <span class="action-text">Apply Validation: </span>
                      <ul class="validation-rules-list">
                        <li
                          *ngIf="rulesBreak.validation_min_value !== undefined"
                        >
                          Min Value:
                          <span class="parameter-value">{{
                            rulesBreak.validation_min_value
                          }}</span>
                        </li>
                        <li
                          *ngIf="rulesBreak.validation_max_value !== undefined"
                        >
                          Max Value:
                          <span class="parameter-value">{{
                            rulesBreak.validation_max_value
                          }}</span>
                        </li>
                        <li *ngIf="rulesBreak.validation_regex_pattern">
                          Regex:
                          <span class="parameter-value">{{
                            rulesBreak.validation_regex_pattern
                          }}</span>
                        </li>
                        <li *ngIf="rulesBreak.validation_message_for_rule">
                          Message:
                          <span class="parameter-value">{{
                            rulesBreak.validation_message_for_rule
                          }}</span>
                        </li>
                      </ul>
                    </ng-container>
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div
            *ngIf="getAllBranchingRulesData?.data?.length === 0"
            class="no-rules"
          >
            <p>No branching rules added yet.</p>
          </div>

          <!-- Create New Rule Section -->
          <form (ngSubmit)="submitAllRules()" #rulesForm="ngForm">
            <div
              *ngFor="let rule of ruleBlocks; let i = index"
              class="rule-block"
            >
              <h3>Set New Rule #{{ i + 1 }}</h3>

              <div class="form-group">
                <label>Select Stage</label>
                <p-dropdown
                  [options]="processCreationData.data.stages"
                  [(ngModel)]="rule.stage_id"
                  (onChange)="onStageChange($event.value, i)"
                  optionLabel="stage_name"
                  optionValue="stage_id"
                  placeholder="Select Stage"
                  name="stage_{{ i }}"
                ></p-dropdown>
              </div>

              <div class="form-group">
                <label>Select Task</label>
                <p-dropdown
                  *ngIf="stageWiseTaskList"
                  [options]="stageWiseTaskList.data"
                  [(ngModel)]="rule.task_id"
                  (onChange)="onTaskChange($event.value, i)"
                  optionLabel="task_name"
                  optionValue="task_id"
                  placeholder="Select Task"
                  name="task_{{ i }}"
                ></p-dropdown>
              </div>

              <div class="form-group">
                <label>Select Parameter</label>
                <p-dropdown
                  *ngIf="taskWiseParameterList"
                  [options]="taskWiseParameterList.data"
                  [(ngModel)]="rule.parameter_id"
                  (onChange)="onParameterChange($event.value, i)"
                  optionLabel="parameter_name"
                  optionValue="parameter_id"
                  placeholder="Select Parameter"
                  name="parameter_{{ i }}"
                ></p-dropdown>
              </div>

              <div *ngIf="rule.parameter_id" class="form-group">
                <label>If Value of the Selected Parameter</label>
                <p-dropdown
                  *ngIf="parameterOptionList!.all_list!.length > 0; else textInput"
                  [options]="parameterOptionList!.all_list!"
                  [(ngModel)]="rule.parameter_value"
                  optionLabel="options_for_parameter"
                  optionValue="options_for_parameter"
                  placeholder="Select Value"
                  name="value_{{ i }}"
                ></p-dropdown>
                <ng-template #textInput>
                  <input
                    type="text"
                    pInputText
                    [(ngModel)]="rule.parameter_value"
                    name="value_{{ i }}"
                    placeholder="Enter Value"
                  />
                </ng-template>
              </div>

              <div class="form-group">
                <label>Select Operator</label>
                <p-dropdown
                  [options]="operatorOptions"
                  [(ngModel)]="rule.operator"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Select Operator"
                  name="operator_{{ i }}"
                ></p-dropdown>
              </div>

              <div class="form-group">
                <label>Select Action Type</label>
                <p-dropdown
                  [options]="actionTypeOptions"
                  [(ngModel)]="rule.action_type"
                  (onChange)="onActionTypeChange($event.value, i)"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Select Action"
                  name="actionType_{{ i }}"
                ></p-dropdown>
              </div>

              <div
                *ngIf="rule.action_type === BranchingActionType.DISPLAY_MESSAGE"
                class="form-group"
              >
                <label>Message to Display</label>
                <input
                  type="text"
                  pInputText
                  [(ngModel)]="rule.display_message_content"
                  name="message_{{ i }}"
                  placeholder="Enter message here"
                />
              </div>

              <div
                *ngIf="rule.action_type === BranchingActionType.HIDE_PARAMETER && taskWiseParameterList"
                class="form-group"
              >
                <label>Target Parameter to Hide</label>
                <p-dropdown
                  [options]="taskWiseParameterList.data"
                  [(ngModel)]="rule.target_parameter_id"
                  optionLabel="parameter_name"
                  optionValue="parameter_id"
                  placeholder="Select Target Parameter"
                  name="targetParam_{{ i }}"
                ></p-dropdown>
              </div>

              <button
                *ngIf="i > 0"
                type="button"
                class="delete-btn"
                (click)="deleteRuleBlock(i)"
              >
                Delete Rule
              </button>
              <hr />
            </div>

            <div class="button-wrapper">
              <button type="button" class="add-btn" (click)="addRuleBlock()">
                <i class="pi pi-plus-circle"></i> Add Another Rule
              </button>
              <button type="submit" class="submit-btn">Submit All Rules</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>
